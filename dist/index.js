"use strict";var ke=Object.create;var C=Object.defineProperty;var De=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var Pe=Object.getPrototypeOf,Ge=Object.prototype.hasOwnProperty;var J=(n,e)=>{for(var t in e)C(n,t,{get:e[t],enumerable:!0})},ae=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of je(e))!Ge.call(n,o)&&o!==t&&C(n,o,{get:()=>e[o],enumerable:!(r=De(e,o))||r.enumerable});return n};var de=(n,e,t)=>(t=n!=null?ke(Pe(n)):{},ae(e||!n||!n.__esModule?C(t,"default",{value:n,enumerable:!0}):t,n)),Fe=n=>ae(C({},"__esModule",{value:!0}),n);var po={};J(po,{Graph:()=>T,THREE:()=>lo,apply:()=>V,clearAll:()=>re,createNode:()=>v,dslContext:()=>Q,executeDSL:()=>we,getObjectRegistry:()=>Me,map:()=>ue,parseDSL:()=>oe,setScene:()=>Oe});module.exports=Fe(po);var f=de(require("three"));var K={};J(K,{add:()=>nn,applyMatrix4:()=>We,applyQuaternion:()=>He,attach:()=>sn,clear:()=>on,clone:()=>Sn,copy:()=>_n,getObjectById:()=>an,getObjectByName:()=>dn,getObjectByProperty:()=>cn,getObjectsByProperty:()=>un,getWorldDirection:()=>fn,getWorldPosition:()=>pn,getWorldQuaternion:()=>ln,getWorldScale:()=>yn,localToWorld:()=>Xe,lookAt:()=>en,raycast:()=>gn,remove:()=>tn,removeFromParent:()=>rn,rotateOnAxis:()=>$e,rotateOnWorldAxis:()=>Ie,rotateX:()=>ze,rotateY:()=>Ue,rotateZ:()=>qe,setRotationFromAxisAngle:()=>Le,setRotationFromEuler:()=>Ce,setRotationFromMatrix:()=>Ve,setRotationFromQuaternion:()=>Be,toJSON:()=>Tn,translateOnAxis:()=>Ze,translateX:()=>Qe,translateY:()=>Je,translateZ:()=>Ke,traverse:()=>hn,traverseAncestors:()=>bn,traverseVisible:()=>mn,updateMatrix:()=>xn,updateMatrixWorld:()=>vn,updateWorldMatrix:()=>Nn,worldToLocal:()=>Ye});var ce=require("three");function We(n,e){return n.applyMatrix4(e),n}function He(n,e){return n.applyQuaternion(e)}function Le(n,e,t){return n.setRotationFromAxisAngle(e,t),n}function Ce(n,e){return n.setRotationFromEuler(e),n}function Ve(n,e){return n.setRotationFromMatrix(e),n}function Be(n,e){return n.setRotationFromQuaternion(e),n}function $e(n,e,t){return n.rotateOnAxis(e,t)}function Ie(n,e,t){return n.rotateOnWorldAxis(e,t)}function ze(n,e){return n.rotateX(e)}function Ue(n,e){return n.rotateY(e)}function qe(n,e){return n.rotateZ(e)}function Ze(n,e,t){return n.translateOnAxis(e,t)}function Qe(n,e){return n.translateX(e)}function Je(n,e){return n.translateY(e)}function Ke(n,e){return n.translateZ(e)}function Xe(n,e){return n.localToWorld(e)}function Ye(n,e){return n.worldToLocal(e)}function en(n,...e){return e.length===1&&e[0]instanceof ce.Vector3?n.lookAt(e[0]):e.length===3&&n.lookAt(e[0],e[1],e[2]),n}function nn(n,...e){return e.forEach(t=>n.add(t)),n}function tn(n,...e){return e.forEach(t=>n.remove(t)),n}function rn(n){return n.removeFromParent()}function on(n){return n.clear()}function sn(n,e){return n.attach(e)}function an(n,e){return n.getObjectById(e)}function dn(n,e){return n.getObjectByName(e)}function cn(n,e,t){return n.getObjectByProperty(e,t)}function un(n,e,t,r){return n.getObjectsByProperty(e,t,r)}function pn(n,e){return n.getWorldPosition(e)}function ln(n,e){return n.getWorldQuaternion(e)}function yn(n,e){return n.getWorldScale(e)}function fn(n,e){return n.getWorldDirection(e)}function gn(n,e,t){return n.raycast(e,t),n}function hn(n,e){n.traverse(e)}function mn(n,e){n.traverseVisible(e)}function bn(n,e){n.traverseAncestors(e)}function xn(n){return n.updateMatrix(),n}function vn(n,e){return n.updateMatrixWorld(e),n}function Nn(n,e,t){return n.updateWorldMatrix(e,t),n}function Tn(n){return n.toJSON(),n}function Sn(n,e){return n.clone(e)}function _n(n,e,t){return n.copy(e,t)}var X={};J(X,{allowOverride:()=>dt,alphaHash:()=>Pn,alphaMap:()=>nr,alphaTest:()=>Gn,alphaToCoverage:()=>Fn,anisotropy:()=>Jt,anisotropyMap:()=>Xt,anisotropyRotation:()=>Kt,aoMap:()=>or,aoMapIntensity:()=>ir,attenuationColor:()=>Dr,attenuationDistance:()=>kr,blendAlpha:()=>Wn,blendColor:()=>Hn,blendDst:()=>Ln,blendDstAlpha:()=>Cn,blendEquation:()=>Vn,blendEquationAlpha:()=>Bn,blendSrc:()=>In,blendSrcAlpha:()=>zn,blending:()=>$n,bumpMap:()=>sr,bumpScale:()=>ar,clearcoat:()=>Ht,clearcoatMap:()=>Ct,clearcoatNormalMap:()=>Bt,clearcoatNormalScale:()=>$t,clearcoatRoughness:()=>Lt,clearcoatRoughnessMap:()=>Vt,clipIntersection:()=>Un,clipShadows:()=>Zn,clippingPlanes:()=>qn,clone:()=>Rn,color:()=>Mt,colorWrite:()=>Qn,combine:()=>Nr,copy:()=>kn,customProgramCacheKey:()=>En,dashSize:()=>Hr,defines:()=>Jn,depthFunc:()=>Kn,depthTest:()=>Xn,depthWrite:()=>Yn,dispersion:()=>It,displacementBias:()=>yr,displacementMap:()=>pr,displacementScale:()=>lr,dispose:()=>Dn,dithering:()=>ct,emissive:()=>Dt,emissiveIntensity:()=>jt,emissiveMap:()=>hr,envMap:()=>vr,envMapIntensity:()=>Sr,envMapRotation:()=>Tr,flatShading:()=>zr,fog:()=>Ur,forceSinglePass:()=>at,format:()=>ht,gapSize:()=>Lr,gradientMap:()=>Mr,iridescence:()=>zt,iridescenceIOR:()=>Ut,iridescenceMap:()=>Zt,iridescenceThicknessMap:()=>Qt,iridescenceThicknessRange:()=>qt,lightMap:()=>tr,lightMapIntensity:()=>rr,linewidth:()=>Wr,map:()=>Yt,matcap:()=>er,metalness:()=>wt,metalnessMap:()=>gr,name:()=>et,normalMap:()=>dr,normalMapType:()=>cr,normalScale:()=>ur,onBeforeCompile:()=>Mn,onBeforeRender:()=>On,opacity:()=>nt,polygonOffset:()=>tt,polygonOffsetFactor:()=>rt,polygonOffsetUnits:()=>ot,precision:()=>it,premultipliedAlpha:()=>st,reflectivity:()=>_r,refractionRatio:()=>Or,rotation:()=>Fr,roughness:()=>Et,roughnessMap:()=>fr,scale:()=>Cr,setNeedsUpdate:()=>jn,setValues:()=>wn,shadowSide:()=>pt,shadowSideNumber:()=>Pr,sheen:()=>At,sheenColor:()=>Rt,sheenRoughness:()=>kt,shininess:()=>Wt,side:()=>ut,size:()=>jr,sizeAttenuation:()=>Gr,specular:()=>Pt,specularColor:()=>Ft,specularColorMap:()=>xr,specularIntensity:()=>Gt,specularIntensityMap:()=>br,specularMap:()=>mr,stencilFail:()=>Tt,stencilFunc:()=>bt,stencilFuncMask:()=>Nt,stencilRef:()=>xt,stencilWrite:()=>mt,stencilWriteMask:()=>vt,stencilZFail:()=>St,stencilZPass:()=>_t,thickness:()=>Ar,thicknessMap:()=>Rr,toJSON:()=>An,toneMapped:()=>lt,transmission:()=>Er,transmissionMap:()=>wr,transparent:()=>yt,userData:()=>Ot,vertexColors:()=>ft,visible:()=>gt,wireframe:()=>Vr,wireframeLinecap:()=>$r,wireframeLinejoin:()=>Ir,wireframeLinewidth:()=>Br});function On(n,e,t,r,o,i){}function Mn(n,e){}function En(){return""}function wn(n){}function An(n){return{}}function Rn(){return{}}function kn(n){return{}}function Dn(){}function jn(n){}function Pn(n,e){n.alphaHash=e}function Gn(n,e){n.alphaTest=e}function Fn(n,e){n.alphaToCoverage=e}function Wn(n,e){n.blendAlpha=e}function Hn(n,e){n.blendColor=e}function Ln(n,e){n.blendDst=e}function Cn(n,e){n.blendDstAlpha=e}function Vn(n,e){n.blendEquation=e}function Bn(n,e){n.blendEquationAlpha=e}function $n(n,e){n.blending=e}function In(n,e){n.blendSrc=e}function zn(n,e){n.blendSrcAlpha=e}function Un(n,e){n.clipIntersection=e}function qn(n,e){n.clippingPlanes=e}function Zn(n,e){n.clipShadows=e}function Qn(n,e){n.colorWrite=e}function Jn(n,e){n.defines=e}function Kn(n,e){n.depthFunc=e}function Xn(n,e){n.depthTest=e}function Yn(n,e){n.depthWrite=e}function et(n,e){n.name=e}function nt(n,e){n.opacity=e}function tt(n,e){n.polygonOffset=e}function rt(n,e){n.polygonOffsetFactor=e}function ot(n,e){n.polygonOffsetUnits=e}function it(n,e){n.precision=e}function st(n,e){n.premultipliedAlpha=e}function at(n,e){n.forceSinglePass=e}function dt(n,e){n.allowOverride=e}function ct(n,e){n.dithering=e}function ut(n,e){n.side=e}function pt(n,e){n.shadowSide=e}function lt(n,e){n.toneMapped=e}function yt(n,e){n.transparent=e}function ft(n,e){n.vertexColors=e}function gt(n,e){n.visible=e}function ht(n,e){n.format=e}function mt(n,e){n.stencilWrite=e}function bt(n,e){n.stencilFunc=e}function xt(n,e){n.stencilRef=e}function vt(n,e){n.stencilWriteMask=e}function Nt(n,e){n.stencilFuncMask=e}function Tt(n,e){n.stencilFail=e}function St(n,e){n.stencilZFail=e}function _t(n,e){n.stencilZPass=e}function Ot(n,e){n.userData=e}function Mt(n,e){n.color=e}function Et(n,e){n.roughness=e}function wt(n,e){n.metalness=e}function At(n,e){n.sheen=e}function Rt(n,e){n.sheenColor=e}function kt(n,e){n.sheenRoughness=e}function Dt(n,e){n.emissive=e}function jt(n,e){n.emissiveIntensity=e}function Pt(n,e){n.specular=e}function Gt(n,e){n.specularIntensity=e}function Ft(n,e){n.specularColor=e}function Wt(n,e){n.shininess=e}function Ht(n,e){n.clearcoat=e}function Lt(n,e){n.clearcoatRoughness=e}function Ct(n,e){n.clearcoatMap=e}function Vt(n,e){n.clearcoatRoughnessMap=e}function Bt(n,e){n.clearcoatNormalMap=e}function $t(n,e){n.clearcoatNormalScale=e}function It(n,e){n.dispersion=e}function zt(n,e){n.iridescence=e}function Ut(n,e){n.iridescenceIOR=e}function qt(n,e){n.iridescenceThicknessRange=e}function Zt(n,e){n.iridescenceMap=e}function Qt(n,e){n.iridescenceThicknessMap=e}function Jt(n,e){n.anisotropy=e}function Kt(n,e){n.anisotropyRotation=e}function Xt(n,e){n.anisotropyMap=e}function Yt(n,e){n.map=e}function er(n,e){n.matcap=e}function nr(n,e){n.alphaMap=e}function tr(n,e){n.lightMap=e}function rr(n,e){n.lightMapIntensity=e}function or(n,e){n.aoMap=e}function ir(n,e){n.aoMapIntensity=e}function sr(n,e){n.bumpMap=e}function ar(n,e){n.bumpScale=e}function dr(n,e){n.normalMap=e}function cr(n,e){n.normalMapType=e}function ur(n,e){n.normalScale=e}function pr(n,e){n.displacementMap=e}function lr(n,e){n.displacementScale=e}function yr(n,e){n.displacementBias=e}function fr(n,e){n.roughnessMap=e}function gr(n,e){n.metalnessMap=e}function hr(n,e){n.emissiveMap=e}function mr(n,e){n.specularMap=e}function br(n,e){n.specularIntensityMap=e}function xr(n,e){n.specularColorMap=e}function vr(n,e){n.envMap=e}function Nr(n,e){n.combine=e}function Tr(n,e){n.envMapRotation=e}function Sr(n,e){n.envMapIntensity=e}function _r(n,e){n.reflectivity=e}function Or(n,e){n.refractionRatio=e}function Mr(n,e){n.gradientMap=e}function Er(n,e){n.transmission=e}function wr(n,e){n.transmissionMap=e}function Ar(n,e){n.thickness=e}function Rr(n,e){n.thicknessMap=e}function kr(n,e){n.attenuationDistance=e}function Dr(n,e){n.attenuationColor=e}function jr(n,e){n.size=e}function Pr(n,e){n.shadowSide=e}function Gr(n,e){n.sizeAttenuation=e}function Fr(n,e){n.rotation=e}function Wr(n,e){n.linewidth=e}function Hr(n,e){n.dashSize=e}function Lr(n,e){n.gapSize=e}function Cr(n,e){n.scale=e}function Vr(n,e){n.wireframe=e}function Br(n,e){n.wireframeLinewidth=e}function $r(n,e){n.wireframeLinecap=e}function Ir(n,e){n.wireframeLinejoin=e}function zr(n,e){n.flatShading=e}function Ur(n,e){n.fog=e}var R=class{constructor(e={}){this.visited=new Set;this.options={showIds:e.showIds??!0,maxDepth:e.maxDepth??10,nodeLabel:e.nodeLabel??this.defaultNodeLabel.bind(this),showDependencyCount:e.showDependencyCount??!0}}defaultNodeLabel(e){let t=e.compute.toString();return t.includes("SphereGeometry")?"sphere":t.includes("BoxGeometry")?"box":t.includes("CylinderGeometry")?"cylinder":t.includes("MeshBasicMaterial")?"material":t.includes("THREE.Mesh")||t.includes("new THREE.Mesh")?"mesh":t.includes("translateXObj")?"translateX":t.includes("translateYObj")?"translateY":t.includes("translateZObj")?"translateZ":t.includes("rotateXObj")?"rotateX":t.includes("rotateYObj")?"rotateY":t.includes("rotateZObj")?"rotateZ":t.includes("currentScene.add")||t.includes("objectRegistry")?"render":t.includes("Graph.run")?"map":"node"}print(e,t=0){let r="  ".repeat(t),o=this.options.showIds?` (${e.id})`:"",i=this.options.showDependencyCount?` [deps: ${e.dependencies.length}]`:"",d=this.options.nodeLabel(e),s=`${r}${d}${o}${i}
`;if(t>=this.options.maxDepth)return s+`${r}  ...(max depth reached)
`;if(this.visited.has(e.id))return s+`${r}  ...(already visited)
`;this.visited.add(e.id);for(let a=0;a<e.dependencies.length;a++){let u=e.dependencies[a],p=a===e.dependencies.length-1?"\u2514\u2500 ":"\u251C\u2500 ";s+=`${r}${p}`,s+=this.print(u,t+1).slice(r.length+p.length)}return s}printForest(e){this.visited.clear();let t="";for(let r=0;r<e.length;r++)r>0&&(t+=`
`),t+=`Root ${r+1}:
`,t+=this.print(e[r]);return t}compact(e){let t=this.options.nodeLabel(e),r=e.dependencies.map(o=>this.compact(o)).join(", ");return r?`${t}(${r})`:t}};var qr=0,Zr=()=>`node-${++qr}`,v=(n,e=[],t)=>new Proxy({id:Zr(),compute:n,dependencies:e},{get(r,o,i){if(r[o])return r[o];if(t[o])return console.log("prop2",o,t[o]),(...d)=>(d=d.map(s=>s.id?s:Qr(s)),v(t[o].fn,[r,...d],t[o].chain()))}}),Y=n=>{let e=n.dependencies.map(t=>Y(t));return n.compute(...e)},ue=(n,e)=>t=>v(n,[t],e),V=(n,e,t)=>v(n,e,t),Qr=n=>v(()=>n,[],{}),Jr=(n,e)=>new R(e).print(n),Kr=(n,e)=>new R(e).compact(n),T=class{};T.run=Y,T.prettyPrint=Jr,T.compact=Kr;var b=class{constructor(e){this._value=e}read(){return this._value}write(e){this._value=e}},x=n=>(n==null?void 0:n.__kind)==="nothing",pe=n=>n===void 0||x(n),le=n=>(n==null?void 0:n.__kind)==="const",ye=n=>(n==null?void 0:n.__kind)==="var",E=n=>(n==null?void 0:n.__kind)==="map",_=n=>(n==null?void 0:n.__kind)==="bind";var B=class{constructor(e=100){this.subscribers=new Map;this.messageHistory=new Map;this.maxHistorySize=100;this.maxHistorySize=e}subscribe(e,t){return this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(t),()=>{let r=this.subscribers.get(e);r&&(r.delete(t),r.size===0&&this.subscribers.delete(e))}}publish(e,t){let r={channel:e,data:t,timestamp:Date.now()};this.messageHistory.has(e)||this.messageHistory.set(e,[]);let o=this.messageHistory.get(e);o.push(r),o.length>this.maxHistorySize&&o.shift();let i=this.subscribers.get(e);i&&i.forEach(d=>{try{d.callback(r)}catch(s){console.error(`Error in pub/sub subscriber ${d.id}:`,s)}})}getLatestMessage(e){let t=this.messageHistory.get(e);return t&&t.length>0?t[t.length-1]:void 0}getMessageHistory(e,t){let r=this.messageHistory.get(e)||[];return t?r.slice(-t):[...r]}getActiveChannels(){return Array.from(this.subscribers.keys())}clearHistory(e){this.messageHistory.delete(e)}clearAllHistory(){this.messageHistory.clear()}getSubscriberCount(e){var t;return((t=this.subscribers.get(e))==null?void 0:t.size)||0}},k=new B;var ee=n=>n&&!!n.value;var $=n=>n&&!!(n!=null&&n.ref);var ne=n=>n&&n.hasOwnProperty("nodes");var D=require("uuid");var z=(n,e)=>Object.fromEntries(Object.entries(n).filter(t=>t[1]).map(t=>[t[0],e(t)])),fe={__kind:"nothing"},U=(n,e)=>(n==null?void 0:n.__kind)==="nothing"?n:e(n),I=class{constructor(){this.nodes=new Map}add(e){this.nodes.set(e.id,e)}get(e){return this.nodes.get(e)}has(e){return this.nodes.has(e)}count(){return this.nodes.size}findKeys(e){return Array.from(this.nodes.keys()).filter(t=>t.startsWith(e))}removeAll(e){for(let t of Array.from(this.nodes.keys()))t&&t.startsWith(e)&&t!==e+"-graphnode"&&t!==e+"-boundNode"&&this.nodes.delete(t)}},ge=(n,e)=>({__kind:"const",id:e??(0,D.v4)(),value:new b(n),compute:()=>n,dependencies:[]}),he=(n,e=(r,o)=>r===o,t)=>({__kind:"var",id:t??(0,D.v4)(),value:new b,set:n,compare:e}),me=(n,e,t,r)=>({__kind:"map",id:r??(0,D.v4)(),value:new b,fn:new b(e),cachedInputs:new b,isStale:t,inputs:z(n,o=>o[1].id),isDirty:new b(!1)}),be=(n,e,t=(o,i)=>!0,r)=>({__kind:"bind",id:r??(0,D.v4)(),value:new b,fn:e,cachedInputs:new b,inputs:z(n,o=>o[1].id),isStale:t,isDirty:new b(!1)}),S=(n,e)=>{console.error(n)};var xe="wrapped",ve=n=>n&&typeof n.then=="function"&&!O(n),O=n=>n&&n.__kind===xe;var Xr=(n,e,t)=>{try{return n(e)}catch(r){if(t)return h(t(r));throw r}},h=(n,e)=>O(n)?n:{__kind:xe,then:t=>h(ve(n)?e?n.then(t).then(r=>O(r)?r.value:r).catch(e):n.then(t).then(r=>O(r)?r.value:r):Xr(t,n,e),e),value:n},j=(n,e)=>{let t=n.reduce((r,o)=>r||ve(O(o)?o.value:o),!1);return h(t?Promise.all(n.map(r=>Promise.resolve(O(r)?r.value:r))):n.map(r=>O(r)?r.value:r),e)},te=(n,e,t,r)=>h(t({previousValue:n,currentValue:e[r],index:r})).then(o=>r<e.length-1?te(o,e,t,r+1):o);var Ne=n=>{let e,t,r=n.indexOf(":");return r>=0?(e=n.substring(0,r),t=n.substring(r+2)):e=n,{type:t!=="default"?t:"any",name:e,default:t==="default"}};var Yr=new Set;function P(n,e,t=!1,r=Yr){let o=Object.keys(n),i=t?[]:Object.keys(e);if(!t&&o.length!==i.length)return!1;for(let d of o)if(!r.has(d)&&n[d]!==e[d])return!1;return!0}var Zo=globalThis.AggregateError||class extends Error{constructor(e,t){super(t),this.errors=e,this.name="AggregateError"}};var G=(n,e)=>`${n}/${e}`,Te=(n,e)=>{var t;return(t=n.edges_in)!=null&&t[e]?Object.values(n.edges_in[e]):Object.values(n.edges).filter(r=>r.to===e)};var li={no:{runtime:{addListener:()=>{},publish:()=>{}}}},yi={},q=globalThis.requestAnimationFrame||(()=>{}),Se={parseValue:n=>{var e;if(typeof n!="string")return n;if(n!=="undefined"){if(typeof n=="string"){if(n.startsWith('"')&&n.endsWith('"'))return n.substring(1,n.length-1);if(n.startsWith("{")||n.startsWith("["))try{return JSON.parse(n.replace(/'/g,'"'))}catch{}if(n.startsWith("0x")){let t=parseInt(n);if(!isNaN(t))return t}if(((e=n.match(/-?[0-9.]*/g))==null?void 0:e[0].length)===n.length){let t=parseFloat(n);if(!isNaN(t))return t}if(n==="false"||n==="true")return n==="true"}return n}}},fi=n=>n.value,eo=(n,e)=>{let t=e.split("."),r=n;for(let o of t)r=r==null?void 0:r[o];return r},no=()=>{},gi=()=>{},Z=class{constructor(n){this.runtime=n}handleExternalNode(n,e,t,r,o,i,d,s,a=!0){return n.ref==="@js.script"?this.handleJavaScriptNode(n,e,t,i,s,a):n.ref==="return"?this.handleReturnNode(n,e,t,r,o,i,d,a):n.ref==="extern"?this.handleExternNode(n,e,t,r,o,i,d,s,a):n.ref==="arg"?this.handleArgNode(n,e,t,r,o,i,d,a):n.ref==="@graph.functional"?this.handleGraphFunctionalNode(n,e,t,i,s,a):n.ref==="@graph.executable"?this.handleGraphExecutableNode(n,e,t,i,s,a):n.ref==="event"?this.handleEventNode(n,e,t,i,s,a):n.ref==="publish"?this.handlePublishNode(n,e,t,i,s,a):n.ref==="extern.frame"?this.handleFrameExtern(i,a):!1}handleJavaScriptNode(n,e,t,r,o,i){let d,s=t.map(a=>a.as);try{d=new Function("_lib","_node","_node_args","wrapPromise",...s,(typeof n.value=="string"?n.value:"")||"")}catch(a){if(S(a,r),this.runtime.scope.has(r))return this.runtime.scope.get(r);d=()=>{}}return this.runtime.mapNode(o(),a=>{try{return d(this.runtime.lib,e,a,h,...s.map(u=>a[u]))}catch(u){S(u,r)}},void 0,r,i)}handleReturnNode(n,e,t,r,o,i,d,s){let a=Object.fromEntries(t.filter(c=>c.as!=="args"&&c.as!=="lib").map(c=>[c.as,this.runtime.constNode(void 0,i+`-input-${c.as}`,!1)])),u=a.value||a.display;return this.runtime.mapNode({result:u},({result:c})=>c&&this.runtime.runNode(c),void 0,i,s)}handleExternNode(n,e,t,r,o,i,d,s,a){let u=n.value;if(u==="extern.switch")return this.handleSwitchNode(t,r,o,i,d,a);if(u==="extern.map")return this.handleMapNode(s,i,a);if(u==="extern.fold")return this.handleFoldNode(s,i,a);if(u==="extern.reference"||u==="extern.state")return this.handleStateNode(t,r,o,i,d,a);if(u==="extern.html_element")return this.handleHtmlElementNode(e,s,i,a);if(u==="extern.frame"){let c=this.runtime.varNode(1,void 0,i,a),p=()=>{c.set(c.value.read()+1),this.runtime.scope.get(i)===c&&q(p)};return q(p),c}return this.handleGenericExternNode(n,s,i,a)}handleFrameExtern(n,e){let t=this.runtime.varNode(1,void 0,n,e),r=()=>{t.set(t.value.read()+1),this.runtime.scope.get(n)===t&&q(r)};return q(r),t}handleSwitchNode(n,e,t,r,o,i){return n.find(s=>s.as==="input")?this.runtime.switchNode(this.runtime.constNode("default",r+"-key",!1),Object.fromEntries(n.filter(s=>s.as!=="input").map(s=>[s.as,this.runtime.constNode(void 0,r+`-${s.as}`,!1)])),r,i):this.runtime.constNode(void 0,r,!1)}handleMapNode(n,e,t){return this.runtime.mapNode(n(),({fn:r,array:o})=>j((Array.isArray(o)?o:Object.entries(o||{})).map((i,d)=>r({element:i,index:d}))),void 0,e,t)}handleFoldNode(n,e,t){return this.runtime.mapNode(n(),({fn:r,object:o,initial:i})=>o===void 0?o:te(i,Array.isArray(o)?o:Object.entries(o),r,0),void 0,e,t)}handleStateNode(n,e,t,r,o,i){let d=this.runtime.varNode(void 0,void 0,r+"-state",i,!0,!0);return this.runtime.mapNode({state:d},({state:s})=>s,()=>!1,r,i)}handleHtmlElementNode(n,e,t,r){return this.runtime.mapNode(e(),o=>{let{dom_type:i,children:d,props:s,value:a}=o;return{dom_type:i??n.value??"div",children:(Array.isArray(d)?d:[d]).filter(u=>u).map(u=>typeof u=="string"?{dom_type:"text_value",text:u}:u),props:s??{},value:a}},void 0,t,r)}handleGenericExternNode(n,e,t,r){let o=e();return this.runtime.mapNode(o,i=>{try{return no()}catch{return}},void 0,t,r)}handleArgNode(n,e,t,r,o,i,d,s){let a=n.value&&typeof n.value=="string"&&Ne(n.value).name;return a?this.runtime.mapNode({closure:d},({closure:u})=>{if(a==="_args")return d;if(a.startsWith("_lib"))return this.runtime.lib;if(a==="__graphid")return o;if(a.includes(".")){let p=a.substring(0,a.indexOf(".")),g=a.substring(a.indexOf(".")+1);return eo(u[p],g)}return u[a]},void 0,i,s):this.runtime.constNode(void 0,i,s)}handleGraphFunctionalNode(n,e,t,r,o,i){let d,s=t.map(a=>a.as);try{d=new Function(...s.sort(),`return (${n.value||"() => undefined"}).apply(this, arguments);`)}catch(a){if(S(a,r),this.runtime.scope.has(r))return this.runtime.scope.get(r);d=()=>{}}return this.runtime.mapNode(o(),a=>{try{let c=s.sort().map(p=>a[p]);return d(...c)}catch(u){S(u,r);return}},void 0,r,i)}handleGraphExecutableNode(refNode,node,edgesIn,nodeGraphId,calculateInputs,useExisting){let executableFn;try{typeof refNode.value=="string"?executableFn=eval(`(${refNode.value})`):typeof refNode.value=="function"?executableFn=refNode.value:executableFn=n=>n}catch(n){S(n,nodeGraphId),executableFn=()=>{}}let inputs=edgesIn.map(n=>n.as);return this.runtime.mapNode(calculateInputs(),n=>{try{let t=inputs.sort().map(o=>n[o]);console.log("handleGraphExecutableNode: args =",n),console.log("handleGraphExecutableNode: orderedArgs =",t);let r=executableFn(...t);return console.log("handleGraphExecutableNode: result =",r),r}catch(e){S(e,nodeGraphId);return}},void 0,nodeGraphId,useExisting)}handleEventNode(n,e,t,r,o,i){let d=typeof n.value=="string"?n.value:"default",s=this.runtime.varNode(void 0,(c,p)=>!1,r+"-event-var",i,!0,!1),a=k.subscribe(d,{id:r,callback:c=>{s.set(c.data)}});this.runtime.eventUnsubscribers||(this.runtime.eventUnsubscribers=new Map),this.runtime.eventUnsubscribers.set(r,a);let u=k.getLatestMessage(d);return u&&s.set(u.data),this.runtime.mapNode({eventVar:s},({eventVar:c})=>c,()=>!1,r,i)}handlePublishNode(n,e,t,r,o,i){let d=typeof n.value=="string"?n.value:"default";return this.runtime.mapNode(o(),s=>{let a=s.data!==void 0?s.data:Object.values(s)[0];return k.publish(d,a),a},void 0,r,i)}};var to=new Set(["name"]),F=class{constructor(){this.scope=new I;this.watches=new Map;this.outputs=new Map;this.inputs=new Map;this.rerun=new Map;this.eventQueue=[];this.running=new Map;this.torun=new Set;this.dirtying=0;this.id="runtime-id";this.event="graph-update";this.store={refs:new Map,persist:new Map,state:new Map};this.externalHandler=new Z(this)}refs(){return this.store.refs.keys()}nodeCount(){return this.scope.count()}createWatch(e){return{[Symbol.asyncIterator]:()=>({next:()=>new Promise(t=>{let r=o=>{var i,d;(d=this.watches.get(e.id))==null||d.splice(((i=this.watches.get(e.id))==null?void 0:i.indexOf(r))??0,1),t({value:o})};this.addWatchFn(e,r)})})}}clearWatch(e,t){var r,o,i;this.watches.has(e.id)&&((r=this.watches.get(e.id))!=null&&r.includes(t))&&((i=this.watches.get(e.id))==null||i.splice(((o=this.watches.get(e.id))==null?void 0:o.indexOf(t))??0,1))}addWatchFn(e,t){var r;this.watches.has(e.id)||this.watches.set(e.id,[]),(r=this.watches.get(e.id))==null||r.push(t),this.checkWatch(e.id)}resetOutputs(e,t){var o,i,d,s;this.outputs.has(e)||this.outputs.set(e,new Set),this.inputs.has(e)||this.inputs.set(e,new Set);let r=!1;if(t){let a;for(a in t)t[a]&&this.outputs.has(t[a].id)&&((o=this.outputs.get(t[a].id))!=null&&o.has(e)||(r=!0,(i=this.outputs.get(t[a].id))==null||i.add(e)),(d=this.inputs.get(e))!=null&&d.has(t[a].id)||(r=!0,(s=this.inputs.get(e))==null||s.add(t[a].id)))}r&&this.dirty(e)}checkWatch(e){let t=this.scope.get(e),r=()=>{var o;this.running.has(e)||((o=this.watches.get(e))==null||o.forEach(i=>{i(this.runNode(this.scope.get(e)))}),this.rerun.delete(e))};this.watches.has(e)&&!this.rerun.has(e)&&!this.running.has(e)&&(!E(t)||t.isDirty.read())&&new Promise(()=>r())}dirty(e,t){this.dirtying+=1;let r=()=>{this.dirtying-=1,this.dirtying===0?(Array.from(this.torun).map(s=>this.checkWatch(s)),this.checkWatch(e),this.torun.clear()):this.torun.add(e)},o=this.scope.get(e);if(E(o)||_(o)){if(o.isDirty.read()){r();return}o.isDirty.write(!0)}if(e===t){r();return}let i,d=this.outputs.get(e)??[];for(i of Array.from(d))this.dirty(i,t);r()}constNode(e,t,r=!0){var s;let o=this.scope.get(t),i=(s=o==null?void 0:o.value)==null?void 0:s.read();if(r&&o&&P(i,e))return o;let d=r&&o?o:ge(e,t);return this.scope.add(d),this.resetOutputs(d.id),this.dirty(d.id),d}varNode(e,t,r,o=!0,i=!0,d=!1){if(o&&r&&this.scope.has(r)){let a=this.scope.get(r);return e&&a.set(e),a}let s=he(a=>{let u=d&&typeof a=="object"&&a.hasOwnProperty("value")?a.value:a,c=s.value.read();return(x(c)||!s.compare(c,u))&&(s.value.write(u),i&&this.dirty(s.id)),u},t,r);return this.scope.add(s),this.resetOutputs(s.id),e!==void 0&&s.set(e),this.dirty(s.id),s}addListenerVarNode(e,t,r=e){}mapNode(e,t,r=()=>!0,o,i=!0){if(i&&o&&this.scope.has(o))return this.scope.get(o);let d=me(e,t,r,o);return this.scope.add(d),this.resetOutputs(d.id,e),this.dirty(d.id),d}bindNode(e,t,r,o,i=!0){if(i&&r&&this.scope.has(r))return this.scope.get(r);let d=this.scope.get(r);if(i&&d)return d;let s=be(e,a=>{let u=s.value.read();return j([t(a),u]).then(([c,p])=>{var g;return p!==c&&c&&((p==null?void 0:p.id)!==c.id&&((g=this.outputs.get(s.id))==null||g.forEach(y=>{var l;return(l=this.outputs.get(c.id))==null?void 0:l.add(y)})),p&&!x(p)&&(p.__kind!==c.__kind||p.id!==c.id||!P(p.value.read(),c.value.read())||(E(p)||_(p))&&p.isDirty.read())&&((E(c)||_(c))&&c.isDirty.write(!1),this.dirty(c.id))),c}).value},o,r);return this.scope.add(s),this.resetOutputs(s.id,e),this.dirty(s.id),s}switchNode(e,t,r,o=!0){let i=z(t,s=>this.constNode(s[1],r&&`${r}-${s[0]}-const`,!1)),d=this.bindNode({key:e,...i},s=>s[s.key],r&&`${r}-bind`,(s,a)=>s.key!==a.key||s[s.key]!==a[a.key],o);return this.mapNode({bound:d},({bound:s})=>{let a=!x(s)&&this.runNode(s);return a!==void 0&&!x(a)?a:void 0},void 0,r,o)}accessorMap(e,t,r,o,i=!1){return this.mapNode({map:e},({map:d})=>d[t],void 0,r+t+"-map",o)}accessor(e,t,r,o,i=!1){return this.mapNode({bound:this.bindNode({map:e},({map:d})=>d[t],r+t+"-bind",void 0,o)},({bound:d})=>this.runNode(d),void 0,r+t+"-map",o)}runNodeNode(e,t,r=!0){return this.mapNode({bound:this.bindNode({bound:e},({bound:o})=>o,t+"-runNodeNodebind",void 0)},({bound:o})=>this.runNode(o),void 0,t,r)}fromNode(e,t,r){return r=r??{},h(typeof e=="string"?this.store.refs.get(e):e).then(o=>this.fromNodeInternal(o,t,o.id,r&&this.constNode(r,G(o.id,t)+"-outerargs"),!0)).value}calcNode(e,t,r,o,i,d,s,a){let u=()=>Object.fromEntries(s.map(c=>[c.as,this.fromNodeInternal(e,c.from,r,d,!0)]));return x(t)?this.constNode(void 0,o,!1):$(t)?this.dereference(e,t,s,r,o,i,u,a):ee(t)?this.mapNode({__graph_value:this.accessor(i,"__parent_graph_value",o+"-accessvalue",a)},({__graph_value:c})=>Se.parseValue(c),void 0,o,a):ne(t)?this.fromNodeInternal(t,t.out??"out",o,this.constNode(u(),o+"-closure",a),a):this.mapNode(u(),c=>c,void 0,o,a)}fromNodeInternal(e,t,r,o,i=!0){let d=e.nodes[t],s=G(r,t);if(i&&this.scope.has(s))return this.scope.get(s);let a=e.id,u=(l,m)=>{if(!l||!m)return!1;let{node:N,edgesIn:L,graph:yo}=l,{node:ie,edgesIn:se,graph:fo}=m;if(!ie||!N||!P(N,ie,!1,to)||L.length!==se.length)return!1;let Ae=L.sort((w,A)=>w.as.localeCompare(A.as)),Re=se.sort((w,A)=>w.as.localeCompare(A.as));return Ae.every((w,A)=>P(w,Re[A]))},c=this.varNode({graph:e,node:e.nodes[t],edgesIn:Te(e,t)},u,s+"-graphnode",!0),p=this.mapNode({graphNodeNode:c},({graphNodeNode:l})=>l.node.value,(l,m)=>l.graphNodeNode.node.value!==m.graphNodeNode.node.value,G(s,"-system-values")),g=this.mapNode({graphClosure:o},({graphClosure:l})=>({...l,__parent_graph_value:p}),void 0,s+"-closure-with-system"),y=this.mapNode({graphNodeNode:c},({graphNodeNode:l})=>{var m;return l.previous&&$(l.previous)&&$(l.node)&&l.node.ref!==((m=l.previous)==null?void 0:m.ref)&&this.scope.has(s)&&this.scope.removeAll(s),h(this.calcNode(l.graph,l.node,r,s,g,o,l.edgesIn,!1)).then(N=>N).value},(l,m)=>{if(!l||!m)return!1;let{graphNodeNode:N}=l,{graphNodeNode:L}=m;return!u(N,L)},s+"-boundNode");return y.graphId=a,y.nodeId=t,this.runNodeNode(y,s,i)}runNode(e){var i,d,s;if(x(e))return e;let t=this.scope.get(e.id);if(!t)return;let r=(i=t.value)==null?void 0:i.read(),o;if(t&&!x(t)&&(ye(t)||le(t)||!((d=t.isDirty)!=null&&d.read())))o=t.value.read();else if(E(t)||_(t)){this.running.has(t.id)||this.running.set(t.id,0),this.running.set(t.id,(this.running.get(t.id)||0)+1);let a=t.cachedInputs.read();return h((()=>{let c=this.scope.get(t.id),p=[],g=Object.keys(c.inputs);for(let y of g){let l=this.scope.get(c.inputs[y]),m=this.runNode(l);l&&p.push(h(m).value)}return j(p).then(y=>y.reduce((l,m,N)=>(l[g[N]]=m,l),{})).value})()).then(c=>{let p=this.scope.get(t.id);if(!p){this.running.has(t.id)&&this.running.delete(t.id);return}if(x(p.value.read())||pe(a)||p.isStale(a,c)){let g=_(t)?U(p.fn,y=>y(c))??fe:U(t.fn,y=>U(typeof y=="function"?y:y.read(),l=>l(c)));return p.value.write(g),p.cachedInputs.write(c),h(g).then(y=>{var m;_(p)&&!x(g)&&g&&this.scope.add(g),p.value.write(y),p.isDirty.write(!1),this.watches.has(t.id)&&((m=this.watches.get(t.id))==null||m.forEach(N=>h(y).then(N)));let l=this.running.get(t.id);return l===1?this.running.delete(t.id):this.running.set(t.id,(l||0)-1),y}).value}return o=p.value.read(),h(o).then(g=>{p.isDirty.write(!1);let y=this.running.get(t.id);return y===1?(this.running.delete(t.id),this.checkWatch(t.id)):this.running.set(t.id,(y||0)-1),g}).value}).value}return this.watches.has(t.id)&&r!==o&&((s=this.watches.get(t.id))==null||s.forEach(a=>h(o).then(a))),o}runGraphNode(e,t){let r=this.scope.get(`${G(typeof e=="string"?e:e.id,t)}-boundNode`);return r?this.runNode(r):h(this.fromNode(e,t)).then(o=>this.runNode(o)).value}run(e){return h(e).then(t=>{let r=typeof t=="string"?t:t.id,o=this.scope.get(r),i=o&&this.runNode(o);return i&&!x(i)&&h(i).value}).value}dereference(e,t,r,o,i,d,s,a=!0,u=t){return h(this.store.refs.get(u.ref),c=>S(c,i)).then(c=>{if(c===void 0)try{return this.externalHandler.handleExternalNode(u,t,r,e,o,i,d,s,a)}catch{throw new Error(`invalid node ref ${u.ref}`)}else if(ne(c)){let p=s(),g=this.accessor(d,"__parent_graph_value",`${i}-internalnodegraphvalue`,a);return this.fromNodeInternal(c,c.out??"out",i,this.constNode({...p,__graph_value:g},i+"-args",!1),a)}else return this.dereference(e,t,r,o,i,d,s,a,c)}).value}};var _e=n=>{let e=new Map,t={},r=i=>{if(e.has(i.id))return i.id;let d=i.dependencies.map(a=>r(a)),s={id:i.id,ref:"@graph.executable",value:i.compute};return e.set(i.id,s),d.forEach((a,u)=>{let c=`${a}->${i.id}`;t[c]={from:a,to:i.id,as:`arg${u}`}}),i.id},o=r(n);return{id:`functional-graph-${Date.now()}`,out:o,nodes:Object.fromEntries(e),edges:t,edges_in:ro(t)}},ro=n=>{let e={};return Object.values(n).forEach(t=>{e[t.to]||(e[t.to]={}),e[t.to][t.from]=t}),e};var W=null,H=new Map;function Oe(n){W=n}function Me(){return H}function re(){W&&H.forEach(n=>{W.remove(n),n instanceof f.Mesh&&(n.geometry.dispose(),n.material instanceof f.Material&&n.material.dispose())}),H.clear(),console.log("Cleared all objects from scene and registry")}var M=Object.fromEntries(Object.entries(K).map(([n,e])=>[n,{fn:e,chain:()=>M}]));M.render={chain:()=>M,fn:(n,e)=>{if(!W)return console.warn("No scene available for rendering"),n;let t=H.get(e);return t?(t.position.copy(n.position),t.rotation.copy(n.rotation),t.scale.copy(n.scale),t instanceof f.Mesh&&n instanceof f.Mesh&&(t.geometry.dispose(),t.geometry=n.geometry,t.material instanceof f.Material&&t.material.dispose(),t.material=n.material),console.log(`Updated existing object: ${e}`),t):(W.add(n),H.set(e,n),console.log(`Created new object: ${e}`),n)}};var Ee=Object.fromEntries(Object.entries(X).map(([n,e])=>[n,{fn:e,chain:()=>Ee}])),oo=(n=1,e=32,t=16)=>v(()=>new f.SphereGeometry(n,e,t),[],M),io=(n=1,e=1,t=1)=>v(()=>new f.BoxGeometry(n,e,t),[],M),so=(n=1,e=1,t=1)=>v(()=>new f.CylinderGeometry(n,e,t),[],M),ao=(n={})=>v(()=>{let e={color:65280,wireframe:!1};return new f.MeshBasicMaterial({...e,...n})},[],Ee),co=(n,e)=>V((t,r)=>new f.Mesh(t,r),[n,e],M),Q={sphere:oo,box:io,cylinder:so,material:ao,mesh:co,clearAll:re,Graph:T,Math,console};function oe(n){try{return new Function(...Object.keys(Q),`return ${n}`)(...Object.values(Q))}catch(e){return console.error("DSL parsing error:",e),null}}var uo={};function we(n){try{let e=oe(n);if(e&&typeof e=="object"&&"compute"in e){let t=_e(e),o=new F().runGraphNode(t,t.out);return o instanceof f.Object3D&&(uo[o.name]=i=>{console.log(i)}),o instanceof f.Object3D?o:null}return e instanceof f.Object3D?e:null}catch(e){return console.error("DSL execution error:",e),null}}var lo=de(require("three"));0&&(module.exports={Graph,THREE,apply,clearAll,createNode,dslContext,executeDSL,getObjectRegistry,map,parseDSL,setScene});
