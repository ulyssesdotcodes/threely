var Se=Object.defineProperty;var re=(n,e)=>{for(var t in e)Se(n,t,{get:e[t],enumerable:!0})};import*as y from"three";var q={};re(q,{add:()=>$e,applyMatrix4:()=>Oe,applyQuaternion:()=>Me,attach:()=>qe,clear:()=>Ue,clone:()=>pn,copy:()=>ln,getObjectById:()=>Ze,getObjectByName:()=>Qe,getObjectByProperty:()=>Je,getObjectsByProperty:()=>Ke,getWorldDirection:()=>nn,getWorldPosition:()=>Xe,getWorldQuaternion:()=>Ye,getWorldScale:()=>en,localToWorld:()=>Ce,lookAt:()=>Be,raycast:()=>tn,remove:()=>Ie,removeFromParent:()=>ze,rotateOnAxis:()=>ke,rotateOnWorldAxis:()=>De,rotateX:()=>je,rotateY:()=>Pe,rotateZ:()=>Ge,setRotationFromAxisAngle:()=>Ee,setRotationFromEuler:()=>we,setRotationFromMatrix:()=>Ae,setRotationFromQuaternion:()=>Re,toJSON:()=>cn,translateOnAxis:()=>Fe,translateX:()=>We,translateY:()=>He,translateZ:()=>Le,traverse:()=>rn,traverseAncestors:()=>sn,traverseVisible:()=>on,updateMatrix:()=>an,updateMatrixWorld:()=>dn,updateWorldMatrix:()=>un,worldToLocal:()=>Ve});import{Vector3 as _e}from"three";function Oe(n,e){return n.applyMatrix4(e),n}function Me(n,e){return n.applyQuaternion(e)}function Ee(n,e,t){return n.setRotationFromAxisAngle(e,t),n}function we(n,e){return n.setRotationFromEuler(e),n}function Ae(n,e){return n.setRotationFromMatrix(e),n}function Re(n,e){return n.setRotationFromQuaternion(e),n}function ke(n,e,t){return n.rotateOnAxis(e,t)}function De(n,e,t){return n.rotateOnWorldAxis(e,t)}function je(n,e){return n.rotateX(e)}function Pe(n,e){return n.rotateY(e)}function Ge(n,e){return n.rotateZ(e)}function Fe(n,e,t){return n.translateOnAxis(e,t)}function We(n,e){return n.translateX(e)}function He(n,e){return n.translateY(e)}function Le(n,e){return n.translateZ(e)}function Ce(n,e){return n.localToWorld(e)}function Ve(n,e){return n.worldToLocal(e)}function Be(n,...e){return e.length===1&&e[0]instanceof _e?n.lookAt(e[0]):e.length===3&&n.lookAt(e[0],e[1],e[2]),n}function $e(n,...e){return e.forEach(t=>n.add(t)),n}function Ie(n,...e){return e.forEach(t=>n.remove(t)),n}function ze(n){return n.removeFromParent()}function Ue(n){return n.clear()}function qe(n,e){return n.attach(e)}function Ze(n,e){return n.getObjectById(e)}function Qe(n,e){return n.getObjectByName(e)}function Je(n,e,t){return n.getObjectByProperty(e,t)}function Ke(n,e,t,r){return n.getObjectsByProperty(e,t,r)}function Xe(n,e){return n.getWorldPosition(e)}function Ye(n,e){return n.getWorldQuaternion(e)}function en(n,e){return n.getWorldScale(e)}function nn(n,e){return n.getWorldDirection(e)}function tn(n,e,t){return n.raycast(e,t),n}function rn(n,e){n.traverse(e)}function on(n,e){n.traverseVisible(e)}function sn(n,e){n.traverseAncestors(e)}function an(n){return n.updateMatrix(),n}function dn(n,e){return n.updateMatrixWorld(e),n}function un(n,e,t){return n.updateWorldMatrix(e,t),n}function cn(n){return n.toJSON(),n}function pn(n,e){return n.clone(e)}function ln(n,e,t){return n.copy(e,t)}var Z={};re(Z,{allowOverride:()=>Jn,alphaHash:()=>Tn,alphaMap:()=>$t,alphaTest:()=>Sn,alphaToCoverage:()=>_n,anisotropy:()=>Ht,anisotropyMap:()=>Ct,anisotropyRotation:()=>Lt,aoMap:()=>Ut,aoMapIntensity:()=>qt,attenuationColor:()=>vr,attenuationDistance:()=>xr,blendAlpha:()=>On,blendColor:()=>Mn,blendDst:()=>En,blendDstAlpha:()=>wn,blendEquation:()=>An,blendEquationAlpha:()=>Rn,blendSrc:()=>Dn,blendSrcAlpha:()=>jn,blending:()=>kn,bumpMap:()=>Zt,bumpScale:()=>Qt,clearcoat:()=>Mt,clearcoatMap:()=>wt,clearcoatNormalMap:()=>Rt,clearcoatNormalScale:()=>kt,clearcoatRoughness:()=>Et,clearcoatRoughnessMap:()=>At,clipIntersection:()=>Pn,clipShadows:()=>Fn,clippingPlanes:()=>Gn,clone:()=>bn,color:()=>ft,colorWrite:()=>Wn,combine:()=>ur,copy:()=>xn,customProgramCacheKey:()=>gn,dashSize:()=>Mr,defines:()=>Hn,depthFunc:()=>Ln,depthTest:()=>Cn,depthWrite:()=>Vn,dispersion:()=>Dt,displacementBias:()=>nr,displacementMap:()=>Yt,displacementScale:()=>er,dispose:()=>vn,dithering:()=>Kn,emissive:()=>vt,emissiveIntensity:()=>Nt,emissiveMap:()=>or,envMap:()=>dr,envMapIntensity:()=>pr,envMapRotation:()=>cr,flatShading:()=>jr,fog:()=>Pr,forceSinglePass:()=>Qn,format:()=>ot,gapSize:()=>Er,gradientMap:()=>fr,iridescence:()=>jt,iridescenceIOR:()=>Pt,iridescenceMap:()=>Ft,iridescenceThicknessMap:()=>Wt,iridescenceThicknessRange:()=>Gt,lightMap:()=>It,lightMapIntensity:()=>zt,linewidth:()=>Or,map:()=>Vt,matcap:()=>Bt,metalness:()=>ht,metalnessMap:()=>rr,name:()=>Bn,normalMap:()=>Jt,normalMapType:()=>Kt,normalScale:()=>Xt,onBeforeCompile:()=>fn,onBeforeRender:()=>yn,opacity:()=>$n,polygonOffset:()=>In,polygonOffsetFactor:()=>zn,polygonOffsetUnits:()=>Un,precision:()=>qn,premultipliedAlpha:()=>Zn,reflectivity:()=>lr,refractionRatio:()=>yr,rotation:()=>_r,roughness:()=>gt,roughnessMap:()=>tr,scale:()=>wr,setNeedsUpdate:()=>Nn,setValues:()=>hn,shadowSide:()=>Yn,shadowSideNumber:()=>Tr,sheen:()=>mt,sheenColor:()=>bt,sheenRoughness:()=>xt,shininess:()=>Ot,side:()=>Xn,size:()=>Nr,sizeAttenuation:()=>Sr,specular:()=>Tt,specularColor:()=>_t,specularColorMap:()=>ar,specularIntensity:()=>St,specularIntensityMap:()=>sr,specularMap:()=>ir,stencilFail:()=>ct,stencilFunc:()=>st,stencilFuncMask:()=>ut,stencilRef:()=>at,stencilWrite:()=>it,stencilWriteMask:()=>dt,stencilZFail:()=>pt,stencilZPass:()=>lt,thickness:()=>mr,thicknessMap:()=>br,toJSON:()=>mn,toneMapped:()=>et,transmission:()=>gr,transmissionMap:()=>hr,transparent:()=>nt,userData:()=>yt,vertexColors:()=>tt,visible:()=>rt,wireframe:()=>Ar,wireframeLinecap:()=>kr,wireframeLinejoin:()=>Dr,wireframeLinewidth:()=>Rr});function yn(n,e,t,r,o,a){}function fn(n,e){}function gn(){return""}function hn(n){}function mn(n){return{}}function bn(){return{}}function xn(n){return{}}function vn(){}function Nn(n){}function Tn(n,e){n.alphaHash=e}function Sn(n,e){n.alphaTest=e}function _n(n,e){n.alphaToCoverage=e}function On(n,e){n.blendAlpha=e}function Mn(n,e){n.blendColor=e}function En(n,e){n.blendDst=e}function wn(n,e){n.blendDstAlpha=e}function An(n,e){n.blendEquation=e}function Rn(n,e){n.blendEquationAlpha=e}function kn(n,e){n.blending=e}function Dn(n,e){n.blendSrc=e}function jn(n,e){n.blendSrcAlpha=e}function Pn(n,e){n.clipIntersection=e}function Gn(n,e){n.clippingPlanes=e}function Fn(n,e){n.clipShadows=e}function Wn(n,e){n.colorWrite=e}function Hn(n,e){n.defines=e}function Ln(n,e){n.depthFunc=e}function Cn(n,e){n.depthTest=e}function Vn(n,e){n.depthWrite=e}function Bn(n,e){n.name=e}function $n(n,e){n.opacity=e}function In(n,e){n.polygonOffset=e}function zn(n,e){n.polygonOffsetFactor=e}function Un(n,e){n.polygonOffsetUnits=e}function qn(n,e){n.precision=e}function Zn(n,e){n.premultipliedAlpha=e}function Qn(n,e){n.forceSinglePass=e}function Jn(n,e){n.allowOverride=e}function Kn(n,e){n.dithering=e}function Xn(n,e){n.side=e}function Yn(n,e){n.shadowSide=e}function et(n,e){n.toneMapped=e}function nt(n,e){n.transparent=e}function tt(n,e){n.vertexColors=e}function rt(n,e){n.visible=e}function ot(n,e){n.format=e}function it(n,e){n.stencilWrite=e}function st(n,e){n.stencilFunc=e}function at(n,e){n.stencilRef=e}function dt(n,e){n.stencilWriteMask=e}function ut(n,e){n.stencilFuncMask=e}function ct(n,e){n.stencilFail=e}function pt(n,e){n.stencilZFail=e}function lt(n,e){n.stencilZPass=e}function yt(n,e){n.userData=e}function ft(n,e){n.color=e}function gt(n,e){n.roughness=e}function ht(n,e){n.metalness=e}function mt(n,e){n.sheen=e}function bt(n,e){n.sheenColor=e}function xt(n,e){n.sheenRoughness=e}function vt(n,e){n.emissive=e}function Nt(n,e){n.emissiveIntensity=e}function Tt(n,e){n.specular=e}function St(n,e){n.specularIntensity=e}function _t(n,e){n.specularColor=e}function Ot(n,e){n.shininess=e}function Mt(n,e){n.clearcoat=e}function Et(n,e){n.clearcoatRoughness=e}function wt(n,e){n.clearcoatMap=e}function At(n,e){n.clearcoatRoughnessMap=e}function Rt(n,e){n.clearcoatNormalMap=e}function kt(n,e){n.clearcoatNormalScale=e}function Dt(n,e){n.dispersion=e}function jt(n,e){n.iridescence=e}function Pt(n,e){n.iridescenceIOR=e}function Gt(n,e){n.iridescenceThicknessRange=e}function Ft(n,e){n.iridescenceMap=e}function Wt(n,e){n.iridescenceThicknessMap=e}function Ht(n,e){n.anisotropy=e}function Lt(n,e){n.anisotropyRotation=e}function Ct(n,e){n.anisotropyMap=e}function Vt(n,e){n.map=e}function Bt(n,e){n.matcap=e}function $t(n,e){n.alphaMap=e}function It(n,e){n.lightMap=e}function zt(n,e){n.lightMapIntensity=e}function Ut(n,e){n.aoMap=e}function qt(n,e){n.aoMapIntensity=e}function Zt(n,e){n.bumpMap=e}function Qt(n,e){n.bumpScale=e}function Jt(n,e){n.normalMap=e}function Kt(n,e){n.normalMapType=e}function Xt(n,e){n.normalScale=e}function Yt(n,e){n.displacementMap=e}function er(n,e){n.displacementScale=e}function nr(n,e){n.displacementBias=e}function tr(n,e){n.roughnessMap=e}function rr(n,e){n.metalnessMap=e}function or(n,e){n.emissiveMap=e}function ir(n,e){n.specularMap=e}function sr(n,e){n.specularIntensityMap=e}function ar(n,e){n.specularColorMap=e}function dr(n,e){n.envMap=e}function ur(n,e){n.combine=e}function cr(n,e){n.envMapRotation=e}function pr(n,e){n.envMapIntensity=e}function lr(n,e){n.reflectivity=e}function yr(n,e){n.refractionRatio=e}function fr(n,e){n.gradientMap=e}function gr(n,e){n.transmission=e}function hr(n,e){n.transmissionMap=e}function mr(n,e){n.thickness=e}function br(n,e){n.thicknessMap=e}function xr(n,e){n.attenuationDistance=e}function vr(n,e){n.attenuationColor=e}function Nr(n,e){n.size=e}function Tr(n,e){n.shadowSide=e}function Sr(n,e){n.sizeAttenuation=e}function _r(n,e){n.rotation=e}function Or(n,e){n.linewidth=e}function Mr(n,e){n.dashSize=e}function Er(n,e){n.gapSize=e}function wr(n,e){n.scale=e}function Ar(n,e){n.wireframe=e}function Rr(n,e){n.wireframeLinewidth=e}function kr(n,e){n.wireframeLinecap=e}function Dr(n,e){n.wireframeLinejoin=e}function jr(n,e){n.flatShading=e}function Pr(n,e){n.fog=e}var A=class{constructor(e={}){this.visited=new Set;this.options={showIds:e.showIds??!0,maxDepth:e.maxDepth??10,nodeLabel:e.nodeLabel??this.defaultNodeLabel.bind(this),showDependencyCount:e.showDependencyCount??!0}}defaultNodeLabel(e){let t=e.compute.toString();return t.includes("SphereGeometry")?"sphere":t.includes("BoxGeometry")?"box":t.includes("CylinderGeometry")?"cylinder":t.includes("MeshBasicMaterial")?"material":t.includes("THREE.Mesh")||t.includes("new THREE.Mesh")?"mesh":t.includes("translateXObj")?"translateX":t.includes("translateYObj")?"translateY":t.includes("translateZObj")?"translateZ":t.includes("rotateXObj")?"rotateX":t.includes("rotateYObj")?"rotateY":t.includes("rotateZObj")?"rotateZ":t.includes("currentScene.add")||t.includes("objectRegistry")?"render":t.includes("Graph.run")?"map":"node"}print(e,t=0){let r="  ".repeat(t),o=this.options.showIds?` (${e.id})`:"",a=this.options.showDependencyCount?` [deps: ${e.dependencies.length}]`:"",d=this.options.nodeLabel(e),i=`${r}${d}${o}${a}
`;if(t>=this.options.maxDepth)return i+`${r}  ...(max depth reached)
`;if(this.visited.has(e.id))return i+`${r}  ...(already visited)
`;this.visited.add(e.id);for(let s=0;s<e.dependencies.length;s++){let c=e.dependencies[s],p=s===e.dependencies.length-1?"\u2514\u2500 ":"\u251C\u2500 ";i+=`${r}${p}`,i+=this.print(c,t+1).slice(r.length+p.length)}return i}printForest(e){this.visited.clear();let t="";for(let r=0;r<e.length;r++)r>0&&(t+=`
`),t+=`Root ${r+1}:
`,t+=this.print(e[r]);return t}compact(e){let t=this.options.nodeLabel(e),r=e.dependencies.map(o=>this.compact(o)).join(", ");return r?`${t}(${r})`:t}};var Gr=0,Fr=()=>`node-${++Gr}`,b=(n,e=[],t)=>new Proxy({id:Fr(),compute:n,dependencies:e},{get(r,o,a){if(r[o])return r[o];if(t[o])return console.log("prop2",o,t[o]),(...d)=>(d=d.map(i=>i.id?i:Hr(i)),b(t[o].fn,[r,...d],t[o].chain()))}}),Q=n=>{let e=n.dependencies.map(t=>Q(t));return n.compute(...e)},Wr=(n,e)=>t=>b(n,[t],e),J=(n,e,t)=>b(n,e,t),Hr=n=>b(()=>n,[],{}),Lr=(n,e)=>new A(e).print(n),Cr=(n,e)=>new A(e).compact(n),N=class{};N.run=Q,N.prettyPrint=Lr,N.compact=Cr;var h=class{constructor(e){this._value=e}read(){return this._value}write(e){this._value=e}},m=n=>n?.__kind==="nothing",oe=n=>n===void 0||m(n),ie=n=>n?.__kind==="const",se=n=>n?.__kind==="var",O=n=>n?.__kind==="map",T=n=>n?.__kind==="bind";var L=class{constructor(e=100){this.subscribers=new Map;this.messageHistory=new Map;this.maxHistorySize=100;this.maxHistorySize=e}subscribe(e,t){return this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(t),()=>{let r=this.subscribers.get(e);r&&(r.delete(t),r.size===0&&this.subscribers.delete(e))}}publish(e,t){let r={channel:e,data:t,timestamp:Date.now()};this.messageHistory.has(e)||this.messageHistory.set(e,[]);let o=this.messageHistory.get(e);o.push(r),o.length>this.maxHistorySize&&o.shift();let a=this.subscribers.get(e);a&&a.forEach(d=>{try{d.callback(r)}catch(i){console.error(`Error in pub/sub subscriber ${d.id}:`,i)}})}getLatestMessage(e){let t=this.messageHistory.get(e);return t&&t.length>0?t[t.length-1]:void 0}getMessageHistory(e,t){let r=this.messageHistory.get(e)||[];return t?r.slice(-t):[...r]}getActiveChannels(){return Array.from(this.subscribers.keys())}clearHistory(e){this.messageHistory.delete(e)}clearAllHistory(){this.messageHistory.clear()}getSubscriberCount(e){return this.subscribers.get(e)?.size||0}},R=new L;var K=n=>n&&!!n.value;var C=n=>n&&!!n?.ref;var X=n=>n&&n.hasOwnProperty("nodes");import{v4 as B}from"uuid";var $=(n,e)=>Object.fromEntries(Object.entries(n).filter(t=>t[1]).map(t=>[t[0],e(t)])),ae={__kind:"nothing"},I=(n,e)=>n?.__kind==="nothing"?n:e(n),V=class{constructor(){this.nodes=new Map}add(e){this.nodes.set(e.id,e)}get(e){return this.nodes.get(e)}has(e){return this.nodes.has(e)}count(){return this.nodes.size}findKeys(e){return Array.from(this.nodes.keys()).filter(t=>t.startsWith(e))}removeAll(e){for(let t of Array.from(this.nodes.keys()))t&&t.startsWith(e)&&t!==e+"-graphnode"&&t!==e+"-boundNode"&&this.nodes.delete(t)}},de=(n,e)=>({__kind:"const",id:e??B(),value:new h(n),compute:()=>n,dependencies:[]}),ue=(n,e=(r,o)=>r===o,t)=>({__kind:"var",id:t??B(),value:new h,set:n,compare:e}),ce=(n,e,t,r)=>({__kind:"map",id:r??B(),value:new h,fn:new h(e),cachedInputs:new h,isStale:t,inputs:$(n,o=>o[1].id),isDirty:new h(!1)}),pe=(n,e,t=(o,a)=>!0,r)=>({__kind:"bind",id:r??B(),value:new h,fn:e,cachedInputs:new h,inputs:$(n,o=>o[1].id),isStale:t,isDirty:new h(!1)}),v=(n,e)=>{console.error(n)};var le="wrapped",ye=n=>n&&typeof n.then=="function"&&!S(n),S=n=>n&&n.__kind===le;var Vr=(n,e,t)=>{try{return n(e)}catch(r){if(t)return f(t(r));throw r}},f=(n,e)=>S(n)?n:{__kind:le,then:t=>f(ye(n)?e?n.then(t).then(r=>S(r)?r.value:r).catch(e):n.then(t).then(r=>S(r)?r.value:r):Vr(t,n,e),e),value:n},k=(n,e)=>{let t=n.reduce((r,o)=>r||ye(S(o)?o.value:o),!1);return f(t?Promise.all(n.map(r=>Promise.resolve(S(r)?r.value:r))):n.map(r=>S(r)?r.value:r),e)},Y=(n,e,t,r)=>f(t({previousValue:n,currentValue:e[r],index:r})).then(o=>r<e.length-1?Y(o,e,t,r+1):o);var fe=n=>{let e,t,r=n.indexOf(":");return r>=0?(e=n.substring(0,r),t=n.substring(r+2)):e=n,{type:t!=="default"?t:"any",name:e,default:t==="default"}};var Br=new Set;function D(n,e,t=!1,r=Br){let o=Object.keys(n),a=t?[]:Object.keys(e);if(!t&&o.length!==a.length)return!1;for(let d of o)if(!r.has(d)&&n[d]!==e[d])return!1;return!0}var Co=globalThis.AggregateError||class extends Error{constructor(e,t){super(t),this.errors=e,this.name="AggregateError"}};var j=(n,e)=>`${n}/${e}`,ge=(n,e)=>n.edges_in?.[e]?Object.values(n.edges_in[e]):Object.values(n.edges).filter(t=>t.to===e);var oi={no:{runtime:{addListener:()=>{},publish:()=>{}}}},ii={},z=globalThis.requestAnimationFrame||(()=>{}),he={parseValue:n=>{if(typeof n!="string")return n;if(n!=="undefined"){if(typeof n=="string"){if(n.startsWith('"')&&n.endsWith('"'))return n.substring(1,n.length-1);if(n.startsWith("{")||n.startsWith("["))try{return JSON.parse(n.replace(/'/g,'"'))}catch{}if(n.startsWith("0x")){let e=parseInt(n);if(!isNaN(e))return e}if(n.match(/-?[0-9.]*/g)?.[0].length===n.length){let e=parseFloat(n);if(!isNaN(e))return e}if(n==="false"||n==="true")return n==="true"}return n}}},si=n=>n.value,$r=(n,e)=>{let t=e.split("."),r=n;for(let o of t)r=r?.[o];return r},Ir=()=>{},ai=()=>{},U=class{constructor(n){this.runtime=n}handleExternalNode(n,e,t,r,o,a,d,i,s=!0){return n.ref==="@js.script"?this.handleJavaScriptNode(n,e,t,a,i,s):n.ref==="return"?this.handleReturnNode(n,e,t,r,o,a,d,s):n.ref==="extern"?this.handleExternNode(n,e,t,r,o,a,d,i,s):n.ref==="arg"?this.handleArgNode(n,e,t,r,o,a,d,s):n.ref==="@graph.functional"?this.handleGraphFunctionalNode(n,e,t,a,i,s):n.ref==="@graph.executable"?this.handleGraphExecutableNode(n,e,t,a,i,s):n.ref==="event"?this.handleEventNode(n,e,t,a,i,s):n.ref==="publish"?this.handlePublishNode(n,e,t,a,i,s):n.ref==="extern.frame"?this.handleFrameExtern(a,s):!1}handleJavaScriptNode(n,e,t,r,o,a){let d,i=t.map(s=>s.as);try{d=new Function("_lib","_node","_node_args","wrapPromise",...i,(typeof n.value=="string"?n.value:"")||"")}catch(s){if(v(s,r),this.runtime.scope.has(r))return this.runtime.scope.get(r);d=()=>{}}return this.runtime.mapNode(o(),s=>{try{return d(this.runtime.lib,e,s,f,...i.map(c=>s[c]))}catch(c){v(c,r)}},void 0,r,a)}handleReturnNode(n,e,t,r,o,a,d,i){let s=Object.fromEntries(t.filter(u=>u.as!=="args"&&u.as!=="lib").map(u=>[u.as,this.runtime.constNode(void 0,a+`-input-${u.as}`,!1)])),c=s.value||s.display;return this.runtime.mapNode({result:c},({result:u})=>u&&this.runtime.runNode(u),void 0,a,i)}handleExternNode(n,e,t,r,o,a,d,i,s){let c=n.value;if(c==="extern.switch")return this.handleSwitchNode(t,r,o,a,d,s);if(c==="extern.map")return this.handleMapNode(i,a,s);if(c==="extern.fold")return this.handleFoldNode(i,a,s);if(c==="extern.reference"||c==="extern.state")return this.handleStateNode(t,r,o,a,d,s);if(c==="extern.html_element")return this.handleHtmlElementNode(e,i,a,s);if(c==="extern.frame"){let u=this.runtime.varNode(1,void 0,a,s),p=()=>{u.set(u.value.read()+1),this.runtime.scope.get(a)===u&&z(p)};return z(p),u}return this.handleGenericExternNode(n,i,a,s)}handleFrameExtern(n,e){let t=this.runtime.varNode(1,void 0,n,e),r=()=>{t.set(t.value.read()+1),this.runtime.scope.get(n)===t&&z(r)};return z(r),t}handleSwitchNode(n,e,t,r,o,a){return n.find(i=>i.as==="input")?this.runtime.switchNode(this.runtime.constNode("default",r+"-key",!1),Object.fromEntries(n.filter(i=>i.as!=="input").map(i=>[i.as,this.runtime.constNode(void 0,r+`-${i.as}`,!1)])),r,a):this.runtime.constNode(void 0,r,!1)}handleMapNode(n,e,t){return this.runtime.mapNode(n(),({fn:r,array:o})=>k((Array.isArray(o)?o:Object.entries(o||{})).map((a,d)=>r({element:a,index:d}))),void 0,e,t)}handleFoldNode(n,e,t){return this.runtime.mapNode(n(),({fn:r,object:o,initial:a})=>o===void 0?o:Y(a,Array.isArray(o)?o:Object.entries(o),r,0),void 0,e,t)}handleStateNode(n,e,t,r,o,a){let d=this.runtime.varNode(void 0,void 0,r+"-state",a,!0,!0);return this.runtime.mapNode({state:d},({state:i})=>i,()=>!1,r,a)}handleHtmlElementNode(n,e,t,r){return this.runtime.mapNode(e(),o=>{let{dom_type:a,children:d,props:i,value:s}=o;return{dom_type:a??n.value??"div",children:(Array.isArray(d)?d:[d]).filter(c=>c).map(c=>typeof c=="string"?{dom_type:"text_value",text:c}:c),props:i??{},value:s}},void 0,t,r)}handleGenericExternNode(n,e,t,r){let o=e();return this.runtime.mapNode(o,a=>{try{return Ir()}catch{return}},void 0,t,r)}handleArgNode(n,e,t,r,o,a,d,i){let s=n.value&&typeof n.value=="string"&&fe(n.value).name;return s?this.runtime.mapNode({closure:d},({closure:c})=>{if(s==="_args")return d;if(s.startsWith("_lib"))return this.runtime.lib;if(s==="__graphid")return o;if(s.includes(".")){let p=s.substring(0,s.indexOf(".")),g=s.substring(s.indexOf(".")+1);return $r(c[p],g)}return c[s]},void 0,a,i):this.runtime.constNode(void 0,a,i)}handleGraphFunctionalNode(n,e,t,r,o,a){let d,i=t.map(s=>s.as);try{d=new Function(...i.sort(),`return (${n.value||"() => undefined"}).apply(this, arguments);`)}catch(s){if(v(s,r),this.runtime.scope.has(r))return this.runtime.scope.get(r);d=()=>{}}return this.runtime.mapNode(o(),s=>{try{let u=i.sort().map(p=>s[p]);return d(...u)}catch(c){v(c,r);return}},void 0,r,a)}handleGraphExecutableNode(refNode,node,edgesIn,nodeGraphId,calculateInputs,useExisting){let executableFn;try{typeof refNode.value=="string"?executableFn=eval(`(${refNode.value})`):typeof refNode.value=="function"?executableFn=refNode.value:executableFn=n=>n}catch(n){v(n,nodeGraphId),executableFn=()=>{}}let inputs=edgesIn.map(n=>n.as);return this.runtime.mapNode(calculateInputs(),n=>{try{let t=inputs.sort().map(o=>n[o]);console.log("handleGraphExecutableNode: args =",n),console.log("handleGraphExecutableNode: orderedArgs =",t);let r=executableFn(...t);return console.log("handleGraphExecutableNode: result =",r),r}catch(e){v(e,nodeGraphId);return}},void 0,nodeGraphId,useExisting)}handleEventNode(n,e,t,r,o,a){let d=typeof n.value=="string"?n.value:"default",i=this.runtime.varNode(void 0,(u,p)=>!1,r+"-event-var",a,!0,!1),s=R.subscribe(d,{id:r,callback:u=>{i.set(u.data)}});this.runtime.eventUnsubscribers||(this.runtime.eventUnsubscribers=new Map),this.runtime.eventUnsubscribers.set(r,s);let c=R.getLatestMessage(d);return c&&i.set(c.data),this.runtime.mapNode({eventVar:i},({eventVar:u})=>u,()=>!1,r,a)}handlePublishNode(n,e,t,r,o,a){let d=typeof n.value=="string"?n.value:"default";return this.runtime.mapNode(o(),i=>{let s=i.data!==void 0?i.data:Object.values(i)[0];return R.publish(d,s),s},void 0,r,a)}};var zr=new Set(["name"]),P=class{constructor(){this.scope=new V;this.watches=new Map;this.outputs=new Map;this.inputs=new Map;this.rerun=new Map;this.eventQueue=[];this.running=new Map;this.torun=new Set;this.dirtying=0;this.id="runtime-id";this.event="graph-update";this.store={refs:new Map,persist:new Map,state:new Map};this.externalHandler=new U(this)}refs(){return this.store.refs.keys()}nodeCount(){return this.scope.count()}createWatch(e){return{[Symbol.asyncIterator]:()=>({next:()=>new Promise(t=>{let r=o=>{this.watches.get(e.id)?.splice(this.watches.get(e.id)?.indexOf(r)??0,1),t({value:o})};this.addWatchFn(e,r)})})}}clearWatch(e,t){this.watches.has(e.id)&&this.watches.get(e.id)?.includes(t)&&this.watches.get(e.id)?.splice(this.watches.get(e.id)?.indexOf(t)??0,1)}addWatchFn(e,t){this.watches.has(e.id)||this.watches.set(e.id,[]),this.watches.get(e.id)?.push(t),this.checkWatch(e.id)}resetOutputs(e,t){this.outputs.has(e)||this.outputs.set(e,new Set),this.inputs.has(e)||this.inputs.set(e,new Set);let r=!1;if(t){let o;for(o in t)t[o]&&this.outputs.has(t[o].id)&&(this.outputs.get(t[o].id)?.has(e)||(r=!0,this.outputs.get(t[o].id)?.add(e)),this.inputs.get(e)?.has(t[o].id)||(r=!0,this.inputs.get(e)?.add(t[o].id)))}r&&this.dirty(e)}checkWatch(e){let t=this.scope.get(e),r=()=>{this.running.has(e)||(this.watches.get(e)?.forEach(o=>{o(this.runNode(this.scope.get(e)))}),this.rerun.delete(e))};this.watches.has(e)&&!this.rerun.has(e)&&!this.running.has(e)&&(!O(t)||t.isDirty.read())&&new Promise(()=>r())}dirty(e,t){this.dirtying+=1;let r=()=>{this.dirtying-=1,this.dirtying===0?(Array.from(this.torun).map(i=>this.checkWatch(i)),this.checkWatch(e),this.torun.clear()):this.torun.add(e)},o=this.scope.get(e);if(O(o)||T(o)){if(o.isDirty.read()){r();return}o.isDirty.write(!0)}if(e===t){r();return}let a,d=this.outputs.get(e)??[];for(a of Array.from(d))this.dirty(a,t);r()}constNode(e,t,r=!0){let o=this.scope.get(t),a=o?.value?.read();if(r&&o&&D(a,e))return o;let d=r&&o?o:de(e,t);return this.scope.add(d),this.resetOutputs(d.id),this.dirty(d.id),d}varNode(e,t,r,o=!0,a=!0,d=!1){if(o&&r&&this.scope.has(r)){let s=this.scope.get(r);return e&&s.set(e),s}let i=ue(s=>{let c=d&&typeof s=="object"&&s.hasOwnProperty("value")?s.value:s,u=i.value.read();return(m(u)||!i.compare(u,c))&&(i.value.write(c),a&&this.dirty(i.id)),c},t,r);return this.scope.add(i),this.resetOutputs(i.id),e!==void 0&&i.set(e),this.dirty(i.id),i}addListenerVarNode(e,t,r=e){}mapNode(e,t,r=()=>!0,o,a=!0){if(a&&o&&this.scope.has(o))return this.scope.get(o);let d=ce(e,t,r,o);return this.scope.add(d),this.resetOutputs(d.id,e),this.dirty(d.id),d}bindNode(e,t,r,o,a=!0){if(a&&r&&this.scope.has(r))return this.scope.get(r);let d=this.scope.get(r);if(a&&d)return d;let i=pe(e,s=>{let c=i.value.read();return k([t(s),c]).then(([u,p])=>(p!==u&&u&&(p?.id!==u.id&&this.outputs.get(i.id)?.forEach(g=>this.outputs.get(u.id)?.add(g)),p&&!m(p)&&(p.__kind!==u.__kind||p.id!==u.id||!D(p.value.read(),u.value.read())||(O(p)||T(p))&&p.isDirty.read())&&((O(u)||T(u))&&u.isDirty.write(!1),this.dirty(u.id))),u)).value},o,r);return this.scope.add(i),this.resetOutputs(i.id,e),this.dirty(i.id),i}switchNode(e,t,r,o=!0){let a=$(t,i=>this.constNode(i[1],r&&`${r}-${i[0]}-const`,!1)),d=this.bindNode({key:e,...a},i=>i[i.key],r&&`${r}-bind`,(i,s)=>i.key!==s.key||i[i.key]!==s[s.key],o);return this.mapNode({bound:d},({bound:i})=>{let s=!m(i)&&this.runNode(i);return s!==void 0&&!m(s)?s:void 0},void 0,r,o)}accessorMap(e,t,r,o,a=!1){return this.mapNode({map:e},({map:d})=>d[t],void 0,r+t+"-map",o)}accessor(e,t,r,o,a=!1){return this.mapNode({bound:this.bindNode({map:e},({map:d})=>d[t],r+t+"-bind",void 0,o)},({bound:d})=>this.runNode(d),void 0,r+t+"-map",o)}runNodeNode(e,t,r=!0){return this.mapNode({bound:this.bindNode({bound:e},({bound:o})=>o,t+"-runNodeNodebind",void 0)},({bound:o})=>this.runNode(o),void 0,t,r)}fromNode(e,t,r){return r=r??{},f(typeof e=="string"?this.store.refs.get(e):e).then(o=>this.fromNodeInternal(o,t,o.id,r&&this.constNode(r,j(o.id,t)+"-outerargs"),!0)).value}calcNode(e,t,r,o,a,d,i,s){let c=()=>Object.fromEntries(i.map(u=>[u.as,this.fromNodeInternal(e,u.from,r,d,!0)]));return m(t)?this.constNode(void 0,o,!1):C(t)?this.dereference(e,t,i,r,o,a,c,s):K(t)?this.mapNode({__graph_value:this.accessor(a,"__parent_graph_value",o+"-accessvalue",s)},({__graph_value:u})=>he.parseValue(u),void 0,o,s):X(t)?this.fromNodeInternal(t,t.out??"out",o,this.constNode(c(),o+"-closure",s),s):this.mapNode(c(),u=>u,void 0,o,s)}fromNodeInternal(e,t,r,o,a=!0){let d=e.nodes[t],i=j(r,t);if(a&&this.scope.has(i))return this.scope.get(i);let s=e.id,c=(l,x)=>{if(!l||!x)return!1;let{node:W,edgesIn:H,graph:to}=l,{node:ne,edgesIn:te,graph:ro}=x;if(!ne||!W||!D(W,ne,!1,zr)||H.length!==te.length)return!1;let Ne=H.sort((E,w)=>E.as.localeCompare(w.as)),Te=te.sort((E,w)=>E.as.localeCompare(w.as));return Ne.every((E,w)=>D(E,Te[w]))},u=this.varNode({graph:e,node:e.nodes[t],edgesIn:ge(e,t)},c,i+"-graphnode",!0),p=this.mapNode({graphNodeNode:u},({graphNodeNode:l})=>l.node.value,(l,x)=>l.graphNodeNode.node.value!==x.graphNodeNode.node.value,j(i,"-system-values")),g=this.mapNode({graphClosure:o},({graphClosure:l})=>({...l,__parent_graph_value:p}),void 0,i+"-closure-with-system"),M=this.mapNode({graphNodeNode:u},({graphNodeNode:l})=>(l.previous&&C(l.previous)&&C(l.node)&&l.node.ref!==l.previous?.ref&&this.scope.has(i)&&this.scope.removeAll(i),f(this.calcNode(l.graph,l.node,r,i,g,o,l.edgesIn,!1)).then(x=>x).value),(l,x)=>{if(!l||!x)return!1;let{graphNodeNode:W}=l,{graphNodeNode:H}=x;return!c(W,H)},i+"-boundNode");return M.graphId=s,M.nodeId=t,this.runNodeNode(M,i,a)}runNode(e){if(m(e))return e;let t=this.scope.get(e.id);if(!t)return;let r=t.value?.read(),o;if(t&&!m(t)&&(se(t)||ie(t)||!t.isDirty?.read()))o=t.value.read();else if(O(t)||T(t)){this.running.has(t.id)||this.running.set(t.id,0),this.running.set(t.id,(this.running.get(t.id)||0)+1);let a=t.cachedInputs.read();return f((()=>{let i=this.scope.get(t.id),s=[],c=Object.keys(i.inputs);for(let u of c){let p=this.scope.get(i.inputs[u]),g=this.runNode(p);p&&s.push(f(g).value)}return k(s).then(u=>u.reduce((p,g,M)=>(p[c[M]]=g,p),{})).value})()).then(i=>{let s=this.scope.get(t.id);if(!s){this.running.has(t.id)&&this.running.delete(t.id);return}if(m(s.value.read())||oe(a)||s.isStale(a,i)){let c=T(t)?I(s.fn,u=>u(i))??ae:I(t.fn,u=>I(typeof u=="function"?u:u.read(),p=>p(i)));return s.value.write(c),s.cachedInputs.write(i),f(c).then(u=>{T(s)&&!m(c)&&c&&this.scope.add(c),s.value.write(u),s.isDirty.write(!1),this.watches.has(t.id)&&this.watches.get(t.id)?.forEach(g=>f(u).then(g));let p=this.running.get(t.id);return p===1?this.running.delete(t.id):this.running.set(t.id,(p||0)-1),u}).value}return o=s.value.read(),f(o).then(c=>{s.isDirty.write(!1);let u=this.running.get(t.id);return u===1?(this.running.delete(t.id),this.checkWatch(t.id)):this.running.set(t.id,(u||0)-1),c}).value}).value}return this.watches.has(t.id)&&r!==o&&this.watches.get(t.id)?.forEach(a=>f(o).then(a)),o}runGraphNode(e,t){let r=this.scope.get(`${j(typeof e=="string"?e:e.id,t)}-boundNode`);return r?this.runNode(r):f(this.fromNode(e,t)).then(o=>this.runNode(o)).value}run(e){return f(e).then(t=>{let r=typeof t=="string"?t:t.id,o=this.scope.get(r),a=o&&this.runNode(o);return a&&!m(a)&&f(a).value}).value}dereference(e,t,r,o,a,d,i,s=!0,c=t){return f(this.store.refs.get(c.ref),u=>v(u,a)).then(u=>{if(u===void 0)try{return this.externalHandler.handleExternalNode(c,t,r,e,o,a,d,i,s)}catch{throw new Error(`invalid node ref ${c.ref}`)}else if(X(u)){let p=i(),g=this.accessor(d,"__parent_graph_value",`${a}-internalnodegraphvalue`,s);return this.fromNodeInternal(u,u.out??"out",a,this.constNode({...p,__graph_value:g},a+"-args",!1),s)}else return this.dereference(e,t,r,o,a,d,i,s,u)}).value}};var me=n=>{let e=new Map,t={},r=a=>{if(e.has(a.id))return a.id;let d=a.dependencies.map(s=>r(s)),i={id:a.id,ref:"@graph.executable",value:a.compute};return e.set(a.id,i),d.forEach((s,c)=>{let u=`${s}->${a.id}`;t[u]={from:s,to:a.id,as:`arg${c}`}}),a.id},o=r(n);return{id:`functional-graph-${Date.now()}`,out:o,nodes:Object.fromEntries(e),edges:t,edges_in:Ur(t)}},Ur=n=>{let e={};return Object.values(n).forEach(t=>{e[t.to]||(e[t.to]={}),e[t.to][t.from]=t}),e};var G=null,F=new Map;function qr(n){G=n}function Zr(){return F}function be(){G&&F.forEach(n=>{G.remove(n),n instanceof y.Mesh&&(n.geometry.dispose(),n.material instanceof y.Material&&n.material.dispose())}),F.clear(),console.log("Cleared all objects from scene and registry")}var _=Object.fromEntries(Object.entries(q).map(([n,e])=>[n,{fn:e,chain:()=>_}]));_.render={chain:()=>_,fn:(n,e)=>{if(!G)return console.warn("No scene available for rendering"),n;let t=F.get(e);return t?(t.position.copy(n.position),t.rotation.copy(n.rotation),t.scale.copy(n.scale),t instanceof y.Mesh&&n instanceof y.Mesh&&(t.geometry.dispose(),t.geometry=n.geometry,t.material instanceof y.Material&&t.material.dispose(),t.material=n.material),console.log(`Updated existing object: ${e}`),t):(G.add(n),F.set(e,n),console.log(`Created new object: ${e}`),n)}};var xe=Object.fromEntries(Object.entries(Z).map(([n,e])=>[n,{fn:e,chain:()=>xe}])),Qr=(n=1,e=32,t=16)=>b(()=>new y.SphereGeometry(n,e,t),[],_),Jr=(n=1,e=1,t=1)=>b(()=>new y.BoxGeometry(n,e,t),[],_),Kr=(n=1,e=1,t=1)=>b(()=>new y.CylinderGeometry(n,e,t),[],_),Xr=(n={})=>b(()=>{let e={color:65280,wireframe:!1};return new y.MeshBasicMaterial({...e,...n})},[],xe),Yr=(n,e)=>J((t,r)=>new y.Mesh(t,r),[n,e],_),ee={sphere:Qr,box:Jr,cylinder:Kr,material:Xr,mesh:Yr,clearAll:be,Graph:N,Math,console};function ve(n){try{return new Function(...Object.keys(ee),`return ${n}`)(...Object.values(ee))}catch(e){return console.error("DSL parsing error:",e),null}}var eo={};function no(n){try{let e=ve(n);if(e&&typeof e=="object"&&"compute"in e){let t=me(e),o=new P().runGraphNode(t,t.out);return o instanceof y.Object3D&&(eo[o.name]=a=>{console.log(a)}),o instanceof y.Object3D?o:null}return e instanceof y.Object3D?e:null}catch(e){return console.error("DSL execution error:",e),null}}import*as Vi from"three";export{N as Graph,Vi as THREE,J as apply,be as clearAll,b as createNode,ee as dslContext,no as executeDSL,Zr as getObjectRegistry,Wr as map,ve as parseDSL,qr as setScene};
